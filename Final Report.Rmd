---
title: "Anime Popularity Analysis"
author: "Zening Ye"
date: "11/22/2021"
output: 
  pdf_document: 
    latex_engine: lualatex
header-includes: 
  - \usepackage{setspace}\renewcommand{\baselinestretch}{1.0}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE, fig.align='center')
pacman::p_load(ggplot2, tidyverse, rstanarm, knitr, kableExtra, stringr, magrittr, gridExtra, lme4, arm, car, lattice)
```

# Abstract

In this project, I will use the data from 2014 to 2017 to analyze the following questions: first, what source(s) of Anime affected the audience more in 2014 to 2017? Second, why did the Anime come up a lot in 2014 to 2017? Last but not least, what type(s) of Anime will be the mainstream in the future? The group-level of this project will be the source of the Anime, there are 12 groups for the source. It is more reliable to fit the model. Last but not least, The report has three aspects to illustrate the entire research: Introduction, Method and Result.

# Introduction

Anime has become more and more popular for the past 5 to 6 years. The original word "Anime" means a hand-drawn and computer animation originating from Japan. In Japanese and Japanese, the Anime includes all animated works, regardless of style or origin. There are plenty of Anime works in the world, such as Movie, Music, ONA, TV, etc. However, some Anime did not have more popularity than others, and they did not have more shows on TV or other.

There are plenty of types, sources and genres in Anime, therefore there will be a lot of combinations whether in TV, Movie, OVA, etc. There are some variables I would like to use to fit the model, such as start day, types, genres, sources, rating, popularity and score. These variables might help me to get some direction for the questions I mentioned above. For instance, how the genres might affect the popularity of the source(manga, original, novel), how rating and score will affect the popularity as well. Furthermore, how will these variables influence the future mainstream of the Anime?

Based on these factors, I would like to use multilevel models to illustrate how these factors affect the mainstream and popularity in single or multiple genres in the future.


# Method

## Data Processiong and Cleaning

The data was came from [Kaggle: Anime dataset: ](https://www.kaggle.com/thunderz/anime-dataset). The dataset I have chosen was cleared, however, it was not good enough for me to move to the next steps. Therefore, I first tidy up the data. I removed the variables that I will not use for the analysis in this report such as title, title_english, synopsis, etc. Second, I renamed some columns for easy access in the future, such as arid_from to star_year. Since I’m focusing on the data from 2008 to 2020, I filtered the data from the original dataset and created a new dataset for exploratory data analysis, which might help to figure out the difference from two different timelines. After cleaning the datasets I will use for the further analysis is listed below:
```{r}
# Function to clean the data 
getData <- function(cod) {
  animate_data <- read_csv("data/anime_data.csv")
  df1 <- animate_data %>% relocate(title,.before = aired_from)
  df1 <- df1[,c(2,3,5,6,7,8,10,11,12,13,14,19)] %>% 
    rename(year_sta = aired_from)
  df2 <- df1 %>% filter(year_sta >= "2008-01-01")
  df2$genres <- str_replace(df2$genres, "\\[", "")
  df2$genres <- str_replace(df2$genres, "\\]", "")
  df2$genres <- str_replace(df2$genres, "\\,", "")
  df2$genres <- str_trim(df2$genres)
  df2$year_sta <- as.Date(df2$year_sta, format = "1984-01-01")
  if(cod == 1) {
    return(df1)
  } else {return(df2)}
}

# More detail in cleaning
df <- getData(2) %>% filter(episodes <= 100)
df$year_sta <- str_replace_all(df$year_sta, "\\-", "\\/")
df$year_sta <- as.Date(df$year_sta)
movie <- df %>% filter(type == "Movie")
tv <- df %>% filter(type == "TV")
music <- df %>% filter(type == "Music")
ona <- df %>% filter(type == "ONA")
ova <- df %>% filter(type == "OVA")
special <- df %>% filter(type == "Special")

# Set up theme for EDA plot
set_theme <- theme_bw() + theme(axis.text.x = element_text(angle = 90), 
        panel.grid = element_blank(), 
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none")
```
\vspace{1.0cm}
| Column            | Description |
| :--:              | :----- |
| title             | Name of the Anime |
| year_sta          | Date on Aired |
| duration          | Duration of Each Episode in min and hour |
| episodes          | Number of episodes in Anime
| genres            | Theme of the Anime |
| popularity        | Famous Level |
| rank              | Rank of the Anime |
| rating            | Level of the Anime, eg. PG-13, R, PG |
| score             | Numerical Level for Anime |
| scored_by         | Population of the rating |
| source            | Category of the Anime |
| type              | Type of the Anime |


## Exploratory Data Analysis

As I mentioned above I will use the data from 2008 to 2020, since during this period, more and more Anime came up, the popularity, rating, and sources are dynamic. The plot below indicates the frequency of the Anime came up in 12 years.
```{r, fig.cap="Frequncy of Anime in 2008-2020", fig.height=4, fig.width= 10}
# Plot the entire distribution in popularity and source of Anime
t1 <- ggplot(df,aes(type, fill = type)) + geom_bar() + theme_bw() + 
  theme(panel.grid = element_blank(), 
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none") +
  labs(x = "Type", y = "Number of Anime")
t2 <- ggplot(df, aes(episodes, fill = type)) + geom_bar() + theme_bw() + 
  theme(panel.grid = element_blank(), 
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(limits=c(0, 60), breaks = c(12, 24, 36, 48)) +
  labs(x = "Episodes", y = "Frequency")
grid.arrange(t1,t2, ncol = 2)
```
*For Figure 1, it is obvious to see the type of Anime in TV with episodes under 24 has more popularity and market share in 2008 to 2020. In addition, the second plot in Figure 1 basically represents the entire then entire stream type of Anime in these years.*
```{r, fig.cap="Frequency of Anime in Different Sources", fig.height=4, fig.width= 10}
# Plot by difference subsets
movie_plot <- ggplot(movie, aes(source, fill = source)) +
  geom_bar() + set_theme + 
  labs(title = "Source in Movie", y = "Frequency")

music_plot <- ggplot(music, aes(source, fill = source)) +
  geom_bar() + set_theme + 
  labs(title = "Source in Music", y = "Frequency")

ona_plot <- ggplot(ona, aes(source, fill = source)) +
  geom_bar() + set_theme + 
  labs(title = "Source in ONA", y = "Frequency")

ova_plot <- ggplot(ova, aes(source, fill = source)) +
  geom_bar() + set_theme + 
  labs(title = "Source in OVA", y = "Frequency")

special_plot <- ggplot(special, aes(source, fill = source)) +
  geom_bar() + set_theme + 
  labs(title = "Source in Special", y = "Frequency")

tv_plot <- ggplot(tv, aes(source, fill = source)) +
  geom_bar() + set_theme + 
  labs(title = "Source in TV", y = "Frequency")

# set the layout for these plots
grid.arrange(movie_plot, tv_plot, nrow = 1)
```
*For Figure 2, in order to show the distribution of Anime in different types, I filtered the original dataset into six different subsets by different types. For instance, I used TV and Movie as examples to illustrate the frequency of source. Apparently, Original and Light Novels are the most famous topics in TV and Movie. *

## Model Fitting
Before I fit the multilevel model, I would like to use the subset I made above to fit a glm model to check their relationship. Since TV and Movies are the most effective sources on Anime, it might help to visualize the relationship. The variables will include score, rating, source, and rank and duration and episodes. Since the popularity level might be too large for fitting the model, I use log(popularity) to fit the linear model.
```{r, fig.height= 3.5, fig.width=6.5, fig.cap="Residual Plot"}
model_1 <- stan_glm(log(popularity) ~ duration + rating + score + source + rank, data = movie, refresh = 0)
model_2 <- stan_glm(log(popularity) ~ duration + rating + score + source + rank, data = tv, refresh = 0)
pred_1 <- posterior_predict(model_1, draws = 1000)
pred_2 <- posterior_predict(model_2, draws = 1000)
par(mfrow=c(1,2))
binnedplot(fitted(model_1), resid(model_1), main = "Movie")
binnedplot(fitted(model_2), resid(model_2), main = "TV")
```
For two two different subsets I fitted two different multilevel models, the variables I use for multilevel are rating, score and rank, for the random effect is $(1 | duration : genres)$. I also used two individual plots to check the model, “Residuals vs. Fitted” and “QQ Plot”. Furthermore the result of two fitted models shown below:
$$
\begin{aligned}
log(popularity) = &16.430 - 0.082\cdot ratingNone- 0.019\cdot ratingPG - 0.419\cdot ratingPG13-0.434\cdot ratingR\\
&-0.619\cdot {ratingR+} - 1.068\cdot score - 0.0001\cdot rank + n_j + \epsilon\\
n_j \sim N(0,\sigma^2_a)
\end{aligned}
$$
where $n_j$ is random effect: $duration:genres$

$$
\begin{aligned}
log(popularity) = &14.62 - 0.465\cdot ratingNone- 0.022\cdot ratingPG-0.946\cdot ratingPG13 - 1.491\cdot ratingR \\ 
&- 1.512\cdot {ratingR+} - 0.899\cdot score - 0.0004\cdot rank + n_j + \epsilon \\
n_j \sim N(0,\sigma^2_a)
\end{aligned}
$$
where $n_j$ is random effect: $duration:genres$

```{r, fig.cap="Anime Type: Movie", fig.height=2}
lmer_model_1 <- lmer(log(popularity) ~ rating + score + rank + (1 | duration:genres), data = movie)
lmerp_1a <- plot(lmer_model_1,main ='Residuals vs Fitted')
lmerp_2a <- qqmath(lmer_model_1,main='QQ Plot')
grid.arrange(lmerp_1a, lmerp_2a, nrow = 1)
```

```{r, fig.cap="Type of Anime: TV", fig.height=2}
lmer_model_2 <- lmer(log(popularity) ~ rating + score + rank + (1 | duration:genres), data = tv)
lmerp_1b <- plot(lmer_model_2, main = 'Residuals vs Fitted')
lmerp_2b <- qqmath(lmer_model_2,main='QQ Plot')
grid.arrange(lmerp_1b, lmerp_2b, nrow = 1)
```
According to the residual analysis, even though I used two different subsets to fit the multilevel model, the “Residuals vs. Fitted” plots indicated that the residual is not good to fit the model, so it might conclude there is not a lot of correlation between the predictors. On the QQ plots, there are plenty of residual points not on the lines, so it might not follow the normal distribution. 

# Result

\newpage
# Appendix
